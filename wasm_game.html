<html>
    <head>
        <title>The Game</title>
        <style type="text/css">
            :root
            {
                --atlas-width: 16px;
                --atlas-height: 16px;
                --atlas-image: url("data:image/png;base64, <!-- ATLAS_FILE_HERE -->");
                --bg-size: calc(3008px/2) calc(2304px/2);
                --tile-scaled: 32px;
            }
            body
            {
                background-color: rgb(20, 20, 20);
                color: white;
                font-family: monospace, fangsong;
                font-size: 12px;
            }
            *
            {
                box-sizing: border-box;
                font-size: 12px;
            }

            .drag-bar {
                cursor: move;
                touch-action: none;
            }

            #meta-game
            {
                min-width: 300px;
            }
            #meta-content
            {
                display: grid;
                grid-template-columns: 1fr 1fr;
                grid-gap: 10px;
            }

            .outer_border
            {
                background: linear-gradient(306deg, #6186ee, #243fa8);
                padding: 2px;
                border-radius: 4px;
                max-width: fit-content;
            }
            .inner_text
            {
                background:#0c2b6c;
                padding: 6px;
                max-width: 300px;
                max-height: 200px;
                overflow: auto;
                border: 1px solid black;
            }
            button.green
            {
                background: linear-gradient(0deg, #015c00, #0fac00);
                border: 1px solid black;
                color: white;
                padding-top: 2px;
                padding-left: 10px;
                padding-right: 10px;
                font-size: 10px;
                border-radius: 2px;
                padding-bottom: 3px;
                cursor: pointer;
            }
            button.red
            {
                background: linear-gradient(0deg, #3d0000, #8b0404);
                border: 1px solid black;
                color: white;
                padding-top: 2px;
                padding-left: 10px;
                padding-right: 10px;
                font-size: 10px;
                border-radius: 2px;
                padding-bottom: 3px;
                cursor: pointer;
            }
            button.blue
            {
                background: linear-gradient(0deg, #002563, #006fae);
                color:  white;
                border: 1px solid black;
                line-height: 20px;
                cursor: pointer;
                font-size: 10px;
            }

            .atlas
            {
                width: var(--atlas-width);
                height: var(--atlas-height);
                /* DEFAULT COORDS ARE BLANK TRANSPARENT SPACE */
                --atlas-x: 0;
                --atlas-y: 45;
                background-image: var(--atlas-image);
                background-size: var(--bg-size);
                background-position: calc(-1 * calc(var(--tile-scaled) * var(--atlas-x))) calc(-1 * calc(var(--tile-scaled) * var(--atlas-y)));
            }
            #viewport {
                --rotate-x: 10deg;
                --rotate-y: 10deg;
                --rotate-z: 0deg;
                --perspective: 1000px;
            }
            .should_3d #viewport {
                transform: perspective(var(--perspective)) rotateX(var(--rotate-x)) rotateY(var(--rotate-y)) rotateZ(var(--rotate-z));
                transform-style: preserve-3d;
                will-change: transform;
            }

            .debug_entity
            {
                border-top: 2px solid purple;
            }
            .debug_block
            {
                border-top: 2px solid red;
            }

            .svg
            {
                background-size: contain;
            }
            .svg-anchor
            {
                background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><path d='M12 22V8'></path><path d='M5 12H2a10 10 0 0 0 20 0h-3'></path><circle cx='12' cy='5' r='3'></circle></svg>");
            }
            .svg-anchor-white
            {
                background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><path d='M12 22V8'></path><path d='M5 12H2a10 10 0 0 0 20 0h-3'></path><circle cx='12' cy='5' r='3'></circle></svg>");
            }
            .svg-ship
            {
                background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><path d='M2 21c.6.5 1.2 1 2.5 1 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1 .6.5 1.2 1 2.5 1 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1'></path><path d='M19.38 20A11.6 11.6 0 0 0 21 14l-9-4-9 4c0 2.9.94 5.34 2.81 7.76'></path><path d='M19 13V7a2 2 0 0 0-2-2H7a2 2 0 0 0-2 2v6'></path><path d='M12 10v4'></path><path d='M12 2v3'></path></svg>");
            }
            .svg-ship-white
            {
                background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><path d='M2 21c.6.5 1.2 1 2.5 1 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1 .6.5 1.2 1 2.5 1 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1'></path><path d='M19.38 20A11.6 11.6 0 0 0 21 14l-9-4-9 4c0 2.9.94 5.34 2.81 7.76'></path><path d='M19 13V7a2 2 0 0 0-2-2H7a2 2 0 0 0-2 2v6'></path><path d='M12 10v4'></path><path d='M12 2v3'></path></svg>");
            }
            .svg-gamepad
            {
                background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><line x1='6' x2='10' y1='11' y2='11'></line><line x1='8' x2='8' y1='9' y2='13'></line><line x1='15' x2='15.01' y1='12' y2='12'></line><line x1='18' x2='18.01' y1='10' y2='10'></line><path d='M17.32 5H6.68a4 4 0 0 0-3.978 3.59c-.006.052-.01.101-.017.152C2.604 9.416 2 14.456 2 16a3 3 0 0 0 3 3c1 0 1.5-.5 2-1l1.414-1.414A2 2 0 0 1 9.828 16h4.344a2 2 0 0 1 1.414.586L17 18c.5.5 1 1 2 1a3 3 0 0 0 3-3c0-1.545-.604-6.584-.685-7.258-.007-.05-.011-.1-.017-.151A4 4 0 0 0 17.32 5z'></path></svg>");
            }
            .svg-gamepad-white
            {
                background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><line x1='6' x2='10' y1='11' y2='11'></line><line x1='8' x2='8' y1='9' y2='13'></line><line x1='15' x2='15.01' y1='12' y2='12'></line><line x1='18' x2='18.01' y1='10' y2='10'></line><path d='M17.32 5H6.68a4 4 0 0 0-3.978 3.59c-.006.052-.01.101-.017.152C2.604 9.416 2 14.456 2 16a3 3 0 0 0 3 3c1 0 1.5-.5 2-1l1.414-1.414A2 2 0 0 1 9.828 16h4.344a2 2 0 0 1 1.414.586L17 18c.5.5 1 1 2 1a3 3 0 0 0 3-3c0-1.545-.604-6.584-.685-7.258-.007-.05-.011-.1-.017-.151A4 4 0 0 0 17.32 5z'></path></svg>");
            }
            .svg-chat
            {
                background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><path d='M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z'></path></svg>");
            }
            .svg-chat-white
            {
                background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><path d='M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z'></path></svg>");
            }
            .svg-compass
            {
                background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><circle cx='12' cy='12' r='10'></circle><polygon points='16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88 16.24 7.76'></polygon></svg>");
            }
            .svg-compass-white
            {
                background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><circle cx='12' cy='12' r='10'></circle><polygon points='16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88 16.24 7.76'></polygon></svg>");
            }
            .svg-handle-bar
            {
                background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><circle cx='9' cy='12' r='1'></circle><circle cx='9' cy='5' r='1'></circle><circle cx='9' cy='19' r='1'></circle><circle cx='15' cy='12' r='1'></circle><circle cx='15' cy='5' r='1'></circle><circle cx='15' cy='19' r='1'></circle></svg>");
            }
            .svg-handle-bar-white
            {
                background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><circle cx='9' cy='12' r='1'></circle><circle cx='9' cy='5' r='1'></circle><circle cx='9' cy='19' r='1'></circle><circle cx='15' cy='12' r='1'></circle><circle cx='15' cy='5' r='1'></circle><circle cx='15' cy='19' r='1'></circle></svg>");
            }
            .svg-question
            {
                background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><path d='M12 19V18.99M12 16C12 11.5 16 12.5 16 9C16 6.79086 14.2091 5 12 5C10.1361 5 8.57002 6.27477 8.12598 8' /></svg>");
            }
            .svg-question
            {
                background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><path d='M12 19V18.99M12 16C12 11.5 16 12.5 16 9C16 6.79086 14.2091 5 12 5C10.1361 5 8.57002 6.27477 8.12598 8' /></svg>");
            }
            .svg-checkmark
            {
                background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><path d='M5 13.3636L8.03559 16.3204C8.42388 16.6986 9.04279 16.6986 9.43108 16.3204L19 7' /></svg>");
            }
            .svg-checkmark-white
            {
                background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><path d='M5 13.3636L8.03559 16.3204C8.42388 16.6986 9.04279 16.6986 9.43108 16.3204L19 7' /></svg>");
            }
            .svg-3d
            {
                background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><path fill-rule='evenodd' clip-rule='evenodd' d='M11.5144 1.12584C11.8164 0.958052 12.1836 0.958052 12.4856 1.12584L21.4845 6.12522C21.4921 6.12942 21.4996 6.13372 21.5071 6.13813C21.8125 6.31781 22 6.64568 22 7V17C22 17.3632 21.8031 17.6978 21.4856 17.8742L12.4856 22.8742C12.1791 23.0445 11.8059 23.0416 11.5022 22.8673L2.51436 17.874C2.19689 17.6977 2 17.3631 2 16.9999V7C2 6.64568 2.18749 6.3177 2.49287 6.13802L2.5073 6.13784L2.51436 6.12584L11.5144 1.12584ZM12.0001 10.856L5.05923 6.99995L12 3.14396L18.9409 7L12.0001 10.856ZM4 8.69951V16.4115L11 20.3004V12.5884L4 8.69951ZM13 12.5884V20.3005L20 16.4116V8.69951L13 12.5884Z' /></svg>");
            }
            .svg-3d-white
            {
                background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><path fill-rule='evenodd' clip-rule='evenodd' d='M11.5144 1.12584C11.8164 0.958052 12.1836 0.958052 12.4856 1.12584L21.4845 6.12522C21.4921 6.12942 21.4996 6.13372 21.5071 6.13813C21.8125 6.31781 22 6.64568 22 7V17C22 17.3632 21.8031 17.6978 21.4856 17.8742L12.4856 22.8742C12.1791 23.0445 11.8059 23.0416 11.5022 22.8673L2.51436 17.874C2.19689 17.6977 2 17.3631 2 16.9999V7C2 6.64568 2.18749 6.3177 2.49287 6.13802L2.5073 6.13784L2.51436 6.12584L11.5144 1.12584ZM12.0001 10.856L5.05923 6.99995L12 3.14396L18.9409 7L12.0001 10.856ZM4 8.69951V16.4115L11 20.3004V12.5884L4 8.69951ZM13 12.5884V20.3005L20 16.4116V8.69951L13 12.5884Z' /></svg>");
            }
            .svg-cancel
            {
                background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'><path d='M6 6L18 18M6 18L18 6' stroke='currentColor' stroke-width='2' stroke-linecap='round'/></svg>");
            }
            .svg-cancel-white
            {
                background-image: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'><path d='M6 6L18 18M6 18L18 6' stroke='white' stroke-width='2' stroke-linecap='round'/></svg>");
            }
            .svg-refresh
            {
                /*<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M20 12c0-4.4-3.6-8-8-8s-8 3.6-8 8 3.6 8 8 8v-2c-3.3 0-6-2.7-6-6s2.7-6 6-6 6 2.7 6 6h-3l4 4 4-4h-3z" fill="#000000"/></svg>*/
            }
            .svg-plus
            {
                /*<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M12 4L12 20M4 12L20 12" stroke="#000000" stroke-width="2" stroke-linecap="round"/></svg>*/
            }
            .svg-minus
            {
                /*<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M4 12L20 12" stroke="#000000" stroke-width="2" stroke-linecap="round"/></svg>*/
            }

            .popup
            {
                position: absolute;
                top: 0px;
                left: 0px;
                z-index: 999999;
                border: 1px solid #709aff;
                background: linear-gradient(1deg, rgb(36 65 163 / 96%), #162070);
                padding: 1rem;
                border-radius: 0.5rem;
                color: rgb(220 235 235 / 1);
            }
            .popup button
            {
                padding: 0.3rem;
                padding-left: 0.6rem;
                padding-right: 0.6rem;
                border-radius: 4px;
                cursor: pointer;
                min-width: 75px;
                text-align: center;

                background: linear-gradient(to bottom,#f2f2f2 45%,#ebebeb 45%,#cfcfcf);
                color: #222;
                border: 1px solid black;
            }
            .popup button:hover
            {
                background: linear-gradient(to bottom,#eaf6fd 45%,#bee6fd 45%,#a7d9f5);
            }
            .popup button.active
            {
                border: 2px solid red;
            }
            .popup .button-with-icon
            {
                display: grid;
                grid-template-columns: max-content 1fr;
                align-items: center;
                grid-gap: 0.75rem;
            }
            .popup input
            {
                display: block;
                border: 2px solid rgb(255 255 255);
                background: linear-gradient(180deg, #10172e, #405c9b);
                padding: 0.5rem;
                border-radius: 0.5rem;
                color: rgb(220 235 235 / 1);
            }
            .popup .grid
            {
                display: grid;
                grid-template-columns: max-content 1fr;
                align-items: center;
                grid-gap: 1px;
            }
            .popup .svg
            {
                margin: 0px auto;
                width: 16px;
                height: 16px;
            }
            .popup .svg.drag-bar
            {
                width: 30px;
                height: 100%;
                margin-right: 10px;
            }
            .popup span.svg
            {
                display: inline-block;
            }
        </style>
        <script type="text/javascript">
            var wasmBase64 = "<!-- WASM_FILE_HERE -->";
            // NOTE: Confirmed that if you open this file as file:// path, you CAN connect to a local websocket without security!

            <!-- STRUCTS_HERE -->

            // GLOBAL VARIABLES HERE
            var wasm;
            var QUERYSTRING = window.location.search;
            var URLPARAMS = new URLSearchParams(QUERYSTRING);
            // // Get a single value
            // const value = urlParams.get('parameter');
            // // Get all values for a parameter
            // const allValues = urlParams.getAll('parameter');
            // // Check if parameter exists
            // const exists = urlParams.has('parameter');
            var IS_MULTIPLAYER = false;
            var should_render_tiles = false;

            function dragElement(element, dragHandle)
            {
                let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
                
                // Mouse events
                dragHandle.onmousedown = dragMouseDown;
                // Touch events
                dragHandle.ontouchstart = dragTouchStart;

                function dragMouseDown(e) {
                    e.preventDefault();
                    pos3 = e.clientX;
                    pos4 = e.clientY;
                    document.onmouseup = closeDragElement;
                    document.onmousemove = elementDrag;
                }

                function dragTouchStart(e) {
                    e.preventDefault();
                    pos3 = e.touches[0].clientX;
                    pos4 = e.touches[0].clientY;
                    document.ontouchend = closeDragElement;
                    document.ontouchmove = elementTouchDrag;
                }

                function elementDrag(e) {
                    e.preventDefault();
                    pos1 = pos3 - e.clientX;
                    pos2 = pos4 - e.clientY;
                    pos3 = e.clientX;
                    pos4 = e.clientY;
                    updatePosition();
                }

                function elementTouchDrag(e) {
                    e.preventDefault();
                    pos1 = pos3 - e.touches[0].clientX;
                    pos2 = pos4 - e.touches[0].clientY;
                    pos3 = e.touches[0].clientX;
                    pos4 = e.touches[0].clientY;
                    updatePosition();
                }

                function updatePosition() {
                    element.style.top = (element.offsetTop - pos2) + "px";
                    element.style.left = (element.offsetLeft - pos1) + "px";
                }

                function closeDragElement() {
                    document.onmouseup = null;
                    document.onmousemove = null;
                    document.ontouchend = null;
                    document.ontouchmove = null;
                }
            }

            var testArrayToBinDumper = function()
            {
                var data = [1, 2, 3, 4, 5, 69, 69420, 420, 666];
                var test_blob = new Blob([new Uint32Array(data)], {type: 'application/octet-stream'});
                var editorDownload = function (data, file_name)
                {
                    const link = document.createElement('a');
                    const url = window.URL.createObjectURL(data);

                    link.href = url;
                    link.download = file_name;
                    document.body.appendChild(link);
                    link.click();

                    document.body.removeChild(link);
                    window.URL.revokeObjectURL(url);
                };
                editorDownload(test_blob, "rvice_sucks.bin");
            };

            function getRandomInt(max)
            {
                return Math.floor(Math.random() * max);
            }

            var importObject = {
                env: {
                    memory: new WebAssembly.Memory({
                        initial: 512,     // 200 pages = ~12.8MB
                        maximum: 2048     // 1000 pages = ~64MB
                    }),
                    js_console_log: function(ptr, len)
                    {
                        var bytes = new Uint8Array(wasm.exports.memory.buffer, ptr, len);
                        var message = new TextDecoder('utf-8').decode(bytes);
                        console.log(message);
                    },
                }
            }

            function formatMemorySize(bytes)
            {
                const kb = bytes / 1024;
                const mb = kb / 1024;
                const gb = mb / 1024;
                
                if (gb >= 1) return `${gb.toFixed(2)} GB`;
                if (mb >= 1) return `${mb.toFixed(2)} MB`;
                if (kb >= 1) return `${kb.toFixed(2)} KB`;
                return `${bytes} Bytes`;
            }

            function is_sentry(value)
            {
                if (value !== wasm.exports.get_sentry() && value !== 4294967295)
                {
                    return false;
                }
                return true;
            }

            function get_layer_value(layer, x, y)
            {
                if (!is_sentry(layer.same_value))
                {
                    return layer.same_value;
                }
                return layer.data[(layer.width * y) + x];
            }

            var BG_CALC_CSS = function (atlas_x, atlas_y)
            {
                return "calc(-1 * calc(" + TILE_SIZE_SCALED + "px * " + atlas_x + ")) calc(-1 * calc(" + TILE_SIZE_SCALED + "px * " + atlas_y + "))";
            }

            var VIEWPORT =
            {
                width: 12,
                height: 12,
            };

            var CAMERA =
            {
                offset: {x: 0, y: 0},
                moveLeft: function ()
                {
                    this.offset.x -= 1;
                    if (this.offset.x < 0)
                    {
                        this.offset.x = 0;
                    }
                },
                moveRight: function ()
                {
                    this.offset.x += 1;
                    var max_offset_x = (WORLDS[gh.current.world].width - (VIEWPORT.width / 2));
                    if (this.offset.x >= max_offset_x)
                    {
                        this.offset.x = max_offset_x - 1;
                    }
                },
                moveUp: function ()
                {
                    this.offset.y -= 1;
                    if (this.offset.y < 0)
                    {
                        this.offset.y = 0;
                    }
                },
                moveDown: function ()
                {
                    this.offset.y += 1;
                    var max_offset_y = (WORLDS[gh.current.world].height - (VIEWPORT.height / 2));
                    if (this.offset.y >= max_offset_y)
                    {
                        this.offset.y = max_offset_y - 1;
                    }
                },
            };

            var LAYER_ATLAS_MAP = {
                // Note: array values are "layer_value", "atlas-x", "atlas-y"
                "athens": {
                    "background_layer": [],
                    "layer_one":[],
                    "layer_two":[],
                    "npc_layer":[],
                },
                "dingus_land": {
                    "background_layer": [],
                    "layer_one":[],
                    "layer_two":[],
                    "npc_layer":[],
                },
            };
            LAYER_ATLAS_MAP["athens"]["background_layer"][1] = [0, 0];
            LAYER_ATLAS_MAP["athens"]["layer_one"][33] = [3, 1];
            LAYER_ATLAS_MAP["athens"]["layer_one"][34] = [33, 0];
            LAYER_ATLAS_MAP["athens"]["layer_one"][35] = [41, 0];
            LAYER_ATLAS_MAP["athens"]["layer_one"][36] = [28, 1];
            LAYER_ATLAS_MAP["athens"]["layer_one"][37] = [7, 1];
            LAYER_ATLAS_MAP["athens"]["layer_one"][38] = [32, 1];
            LAYER_ATLAS_MAP["athens"]["layer_one"][39] = [8, 1];
            LAYER_ATLAS_MAP["athens"]["layer_one"][40] = [46, 0];
            LAYER_ATLAS_MAP["athens"]["layer_one"][41] = [44, 0];
            LAYER_ATLAS_MAP["athens"]["layer_one"][50] = [16, 5];
            LAYER_ATLAS_MAP["athens"]["layer_one"][51] = [16, 6];
            LAYER_ATLAS_MAP["athens"]["layer_one"][52] = [16, 7];
            LAYER_ATLAS_MAP["athens"]["layer_one"][53] = [16, 4];
            LAYER_ATLAS_MAP["athens"]["layer_one"][54] = [24, 5];
            LAYER_ATLAS_MAP["athens"]["layer_one"][55] = [24, 7];
            LAYER_ATLAS_MAP["athens"]["layer_one"][56] = [24, 4];
            LAYER_ATLAS_MAP["athens"]["layer_one"][57] = [21, 8];
            LAYER_ATLAS_MAP["athens"]["layer_one"][58] = [24, 6];
            LAYER_ATLAS_MAP["athens"]["layer_one"][59] = [16, 3];
            LAYER_ATLAS_MAP["athens"]["layer_two"][69] = [12, 0];
            LAYER_ATLAS_MAP["athens"]["layer_two"][70] = [12, 0];
            LAYER_ATLAS_MAP["athens"]["layer_two"][71] = [18, 3];
            LAYER_ATLAS_MAP["athens"]["layer_two"][72] = [18, 4];
            LAYER_ATLAS_MAP["athens"]["npc_layer"][0] = [34, 1];
            LAYER_ATLAS_MAP["athens"]["npc_layer"][1] = [35, 2];
            LAYER_ATLAS_MAP["athens"]["npc_layer"][2] = [36, 2];
            LAYER_ATLAS_MAP["athens"]["npc_layer"][3] = [19, 0];
            LAYER_ATLAS_MAP["athens"]["npc_layer"][4] = [37, 2];
            LAYER_ATLAS_MAP["athens"]["npc_layer"][5] = [40, 2];
            LAYER_ATLAS_MAP["athens"]["npc_layer"][6] = [41, 2];
            LAYER_ATLAS_MAP["athens"]["npc_layer"][7] = [42, 2];
            LAYER_ATLAS_MAP["athens"]["npc_layer"][8] = [43, 2];
            LAYER_ATLAS_MAP["athens"]["npc_layer"][9] = [44, 2];
            LAYER_ATLAS_MAP["dingus_land"]["background_layer"][1] = [0, 0];
            LAYER_ATLAS_MAP["dingus_land"]["layer_one"][42] = [16, 0];
            LAYER_ATLAS_MAP["dingus_land"]["npc_layer"]["player_one"] = [20, 0];
            LAYER_ATLAS_MAP["dingus_land"]["npc_layer"]["player_two"] = [20, 0];
            LAYER_ATLAS_MAP["dingus_land"]["npc_layer"]["player_three"] = [20, 0];
            LAYER_ATLAS_MAP["dingus_land"]["npc_layer"]["player_four"] = [20, 0];
            LAYER_ATLAS_MAP["dingus_land"]["npc_layer"]["player_five"] = [20, 0];
            LAYER_ATLAS_MAP["dingus_land"]["npc_layer"]["npc_blackbeard"] = [20, 0];
            LAYER_ATLAS_MAP["dingus_land"]["npc_layer"]["npc_kraken"] = [18, 0];
            var LAYER_COORDINATES_VALUE_HISTORY = [];
            var LAYER_COORDINATES_VALUE_UNDO_COUNTER = 0;
            var LAYER_COORDINATES_VALUE_REDO_COUNTER = 0;
            var GAME_STRINGS = <!-- GAME_STRINGS_HERE -->;
            var STRINGS = [];
            STRINGS["DIALOG_NPC_RVICE"] = "Rvice: I no likey";
            STRINGS["DIALOG_NPC_LAFOLIE"] = "Lafolie: Lua, bruh";
            STRINGS["DIALOG_NPC_NAKOR"] = "Nakor: Have you even played a game before?";
            STRINGS["DIALOG_NPC_LOLLER"] = "Loller: My mom hurts me";
            STRINGS["DIALOG_NPC_TRAVIS"] = "Travis: You shall call me 'Chief Dingus GigaChad'";
            STRINGS["ITEM_TELESCOPE"] = "Telescope";
            STRINGS["ITEM_QUADRANT"] = "Quadrant";
            STRINGS["ITEM_THEODOLITE"] = "Theodolite";
            STRINGS["ITEM_SEXTANT"] = "Sextant";
            STRINGS["SCENE_GENERAL_SHOP"] = "Welcome to my shop. Have a look around.";
            STRINGS["INVENTORY_TYPE_GENERAL_ITEM"] = "General Item";
            STRINGS["WORLD_ATHENS"] = "Athens";
            STRINGS["WORLD_DINGUS_LAND"] = "Dingus Land";
            STRINGS["LAYER_BACKGROUND"] = "Background";
            STRINGS["LAYER_ONE"] = "One";
            STRINGS["LAYER_TWO"] = "Two";
            STRINGS["LAYER_NPC"] = "NPC";
            STRINGS["LAYER_BLOCK"] = "Block";
            STRINGS["LAYER_ENTITY"] = "Entity";
            STRINGS["DIALOG_BANK_WELCOME"] = "Welcome to Digi Tal Bank. How can we help?";
            STRINGS["ACTION_BANK_DEPOSIT_SUCCESS"] = "We've deposited your gold into your account. Our deposit accounts accrue %d% per year.";
            var UNDERSTRINGS = [];
            UNDERSTRINGS["WORLD_ATHENS"] = "athens";
            UNDERSTRINGS["WORLD_DINGUS_LAND"] = "dingus_land";
            UNDERSTRINGS["NPC_PLAYER_ONE"] = "player_one";
            UNDERSTRINGS["NPC_OCEAN_BATTLE"] = "ocean_battle";
            UNDERSTRINGS["NPC_GENERAL_SHOP_OWNER"] = "general_shop_owner";
            UNDERSTRINGS["NPC_BANK_TELLER"] = "bank_teller";
            UNDERSTRINGS["NPC_BLACKJACK_PLAYER"] = "blackjack_player";
            UNDERSTRINGS["NPC_LOLLER"] = "loller";
            UNDERSTRINGS["NPC_RVICE"] = "rvice";
            UNDERSTRINGS["LAYER_BACKGROUND"] = "background";
            UNDERSTRINGS["LAYER_ONE"] = "one";
            UNDERSTRINGS["LAYER_TWO"] = "two";
            UNDERSTRINGS["LAYER_NPC"] = "npc";
            UNDERSTRINGS["LAYER_BLOCK"] = "block";
            UNDERSTRINGS["LAYER_ENTITY"] = "entity";
            var INVENTORIES = [];
            var WORLDS = [];
            var LAYERS = [];
            var PLAYER = {
                captain: null,
                previous_world_npc_id: null,
                world_npc: null,
            };

            var UI_PLAYER_MENU =
            {
                // TODO: If you hit the start button while this is open, close it and free it up
                data: {
                    inventory: null,
                },
                rendered: false,
                initialized: false,
                initialize: function ()
                {
                    if (!this.initialized)
                    {
                        this.initialized = true;
                        var player_inventory_id = wasm.exports.get_player_inventory_id(0);
                        this.data.inventory = new GAME_DATA_INVENTORY(wasm.exports, [player_inventory_id]);
                    }
                },
                render: function ()
                {
                    if (!this.rendered)
                    {
                        var html = `<div id="player_menu" style="max-width: fit-content; position: absolute; top: 0px;">`;
                        html += `<div>Gold: ${wasm.exports.get_player_gold(0)}</div>`;
                        html += `<div>${this.data.inventory.total_items} Items In Inventory</div>`;
                        for (var i = 0; i < this.data.inventory.total_items; ++i)
                        {
                            if (!is_sentry(this.data.inventory.inventory_items[i]))
                            {
                                var ghi = new GAME_DATA_INVENTORY_ITEM(wasm.exports, [this.data.inventory.inventory_items[i]]);
                                var name = STRINGS[GAME_STRINGS[ghi.name_id]];
                                html += `<div>${name} [${ghi.number_held}]</div>`;
                            }
                        }
                        // Player -> Fleet -> Fleet Ships -> Ships -> BaseShips
                        // ---> Ships/BaseShips -> Material/Cannon Type/Cargo -> Goods/Figurehead
                        // ---> Fleet->general_id = captain_id = player
                        // ---> Fleet->ship_ids = fleet_ships
                        // ---> Fleet->captain_ids = partners in crime
                        // ---> FleetShips->captain_id = captain (if any)
                        // ---> FleetShips->ship_id = ship = ship->base_ship
                        // ---> FleetShips->is_flagship
                        // TODO: Fleet, ships
                        // TODO: Go into fleet and view all ships
                        // TODO: Go look at goods across all ships (lay out which ships goods are in)
                        // TODO: View captains along with you (skills, assignments, ship captaining, monthly wage)
                        // TODO: General things like -> total monthly costs (crew + captains) or ships that need repairs or low on supplies
                        // TODO: Personal stats
                        // TODO: Equipped armor / weapons
                        // TODO: Any special items you can use or special actions to take?
                        html += `<div><button class="red" onclick="UI_PLAYER_MENU.exit();">Exit</button></div>`;
                        html += `</div>`;
                        document.getElementById("player_menu").outerHTML = html;
                        this.rendered = true;
                    }
                },
                exit: function ()
                {
                    document.getElementById("player_menu").outerHTML = `<div id="player_menu"></div>`;
                    gh.current.game_mode = GAME_STRINGS.indexOf("GAME_MODE_IN_PORT");
                    this.rendered = false;
                }
            }

            var UI_SCENE_SINGLE_DIALOG =
            {
                initialized: false,
                initialize: function ()
                {
                    if (!this.initialized)
                    {
                        this.initialized = true;
                    }
                },
                render: function ()
                {
                    var dialog_id = wasm.exports.current_scene_take_action(GAME_STRINGS.indexOf("ACTION"));
                    var game_string = GAME_STRINGS[dialog_id];
                    if (!STRINGS[game_string])
                    {
                        console.error(`Could not find string in strings [${game_string}]`);
                    }
                    var html = `
                    <div id="scene_single_dialog" style="max-width: fit-content; position: absolute; top: 0px;">
                        <div class="outer_border">
                            <div class="inner_text">
                                ${STRINGS[game_string]}
                            </div>
                            <div id="dialog_choices">
                                <button class="green" onclick="UI_SCENE_SINGLE_DIALOG.exit();">Ok</button>
                            </div>
                        </div>
                    </div>
                    `;
                    document.getElementById("scene_single_dialog").outerHTML = html;
                },
                exit: function()
                {
                    wasm.exports.current_scene_take_action(GAME_STRINGS.indexOf("ACTION_CONFIRM"));
                    document
                        .getElementById("scene_single_dialog")
                        .outerHTML = `<div id="scene_single_dialog"></div>`;
                    this.initialized = false;
                },
            }

            var UI_SHIPYARD =
            {
                data: null,
                initialized: false,
                initialize: function ()
                {
                    if (!this.initialized)
                    {
                        this.initialized = true;
                    }
                },
                render: function ()
                {
                    /*
                    <div id="shipyard">
                        <div>Need to be able to create a ship</div>
                        <div>A ship is filtered by the port and investment level but</div>
                        <ul>
                            <li>Type of ship - must choose this first I think so you know lower & upper bounds (size and hull and stuff)</li>
                            <li>Material + type of ship should actually give you a MAX capacity which you can adjust</li>
                            <li>Hull - quite a list, dropdown maybe?</li>
                            <li>Capacity - Cargo</li>
                            <li>Capacity - Cannons</li>
                            <li>Capacity - Crew</li>
                            <li>Cannon Types - times the number of cannons available on shop, also might have to be a dropdown</li>
                            <li>Figurehead - optional, not required</li>
                        </ul>
                        <div>Selling a ship gives you details on that ship. If there's cargo, cargo is sold at local prices. Crew will be released or you can move them into other ships if there's room.</div>
                        <div>You can buy a pre-built ship which doesn't have options except to remodel it down the road, akin to creating it new with the optoins in the new portion</div>
                        <div id="shipyard_info">
                            <div>Your Gold: <span id="shipyard_player_gold">X</span></div>
                            <div>Current Ship Cost: <span id="shipyard_current_cost">X</span></div>
                        </div>
                        <div id="shipyard_actions">
                            <button class="green">Buy</button>
                            <button class="blue">Sell</button>
                            <button class="red">Cancel</button>
                        </div>
                    </div>
                    */
                },
            }

            var UI_BLACKJACK =
            {
                data: null,
                initialized: false,
                initialize: function ()
                {
                    if (!this.initialized)
                    {
                        this.initialized = true;
                    }
                },
                render: function ()
                {
                    /*
                    <div id="blackjack" style="width: 400px;">
                        <div id="bj_dialog">
                            Dealer says stuff here
                        </div>
                        <div id="bj_bet">
                            Bet <input type="number" id="bet_number" style="width: 60px;" />
                        </div>
                        <div id="bj_table">
                            <div style="display: grid; grid-auto-flow: column;">
                                <div>Player</div>
                                <div style="display: grid; grid-auto-flow: column;">
                                    <div class="bj_card">K</div>
                                    <div class="bj_card">K</div>
                                    <div class="bj_card">K</div>
                                    <div class="bj_card">K</div>
                                    <div class="bj_card">K</div>
                                    <div class="bj_card">K</div>
                                    <div class="bj_card">K</div>
                                    <div class="bj_card">K</div>
                                    <div class="bj_card">K</div>
                                    <div class="bj_card">K</div>
                                </div>
                            </div>
                            <div style="display: grid; grid-auto-flow: column;">
                                <div>Dealer</div>
                                <div style="display: grid; grid-auto-flow: column;">
                                    <div class="bj_card">K</div>
                                    <div class="bj_card">K</div>
                                    <div class="bj_card">K</div>
                                    <div class="bj_card">K</div>
                                    <div class="bj_card">K</div>
                                    <div class="bj_card">K</div>
                                    <div class="bj_card">K</div>
                                    <div class="bj_card">K</div>
                                    <div class="bj_card">K</div>
                                    <div class="bj_card">K</div>
                                </div>
                            </div>
                        </div>
                        <div class="info" style="display: grid; grid-auto-flow: column;">
                            <div>Player:</div><div>110</div><div>Dealer:</div><div>110</div>
                        </div>
                        <div class="actions">
                            <button class="green">Place Bet</button>
                            <button class="blue">Hit</button>
                            <button class="blue">Stand</button>
                            <button class="red">Cancel</button>
                        </div>
                    </div>*/
                },
                exit: function ()
                {
                },
            }

            var UI_BANK =
            {
                data: {
                    scene: null,
                    bank: null,
                },
                initialized: false,
                initialize: function ()
                {
                    if (!this.initialized)
                    {
                        this.data = {
                            scene: new GAME_DATA_SCENE_BANK(wasm.exports),
                            bank: new GAME_DATA_BANK(wasm.exports),
                        };
                        this.initialized = true;
                    }
                },
                deposit: function ()
                {
                    var amount = document.getElementById("bank").querySelector("#bank_input_number").value;
                    this.data.bank.to_deposit = amount;
                    wasm.exports.current_scene_take_action(GAME_STRINGS.indexOf("ACTION_BANK_DEPOSIT"));
                    if (!is_sentry(this.data.scene.error_code))
                    {
                        // ERROR_BANK_NOT_ENOUGH_DEPOSIT
                        // ERROR_BANK_NOT_ENOUGH_PLAYER_GOLD
                        // ERROR_BANK_NOT_ENOUGH_WITHDRAW
                        // ERROR_BANK_WITHDRAW_MORE_THAN_DEPOSIT
                        // ERROR_BANK_PAY_EXISTING_LOAN_FIRST
                        // ERROR_BANK_NOT_ENOUGH_LOAN
                        // ERROR_BANK_TOO_MUCH_LOAN
                        // ERROR_BANK_NO_LOAN
                        // ERROR_BANK_PAY_LOAN_NOT_ENOUGH
                        // ERROR_BANK_NOT_ENOUGH_PLAYER_GOLD
                        // ERROR_BANK_PAY_LOAN_MORE_THAN_LOAN
                    }
                    this.render();
                },
                takeLoan: function ()
                {
                    var amount = document.getElementById("bank").querySelector("#bank_input_number").value;
                    this.data.bank.to_loan = amount;
                    wasm.exports.current_scene_take_action(GAME_STRINGS.indexOf("ACTION_BANK_TAKE_LOAN"));
                    if (!is_sentry(this.data.scene.error_code))
                    {
                        // ERROR_BANK_NOT_ENOUGH_DEPOSIT
                        // ERROR_BANK_NOT_ENOUGH_PLAYER_GOLD
                        // ERROR_BANK_NOT_ENOUGH_WITHDRAW
                        // ERROR_BANK_WITHDRAW_MORE_THAN_DEPOSIT
                        // ERROR_BANK_PAY_EXISTING_LOAN_FIRST
                        // ERROR_BANK_NOT_ENOUGH_LOAN
                        // ERROR_BANK_TOO_MUCH_LOAN
                        // ERROR_BANK_NO_LOAN
                        // ERROR_BANK_PAY_LOAN_NOT_ENOUGH
                        // ERROR_BANK_NOT_ENOUGH_PLAYER_GOLD
                        // ERROR_BANK_PAY_LOAN_MORE_THAN_LOAN
                    }
                    this.render();
                },
                payLoan: function ()
                {
                    var amount = document.getElementById("bank").querySelector("#bank_input_number").value;
                    this.data.bank.to_loan = amount;
                    wasm.exports.current_scene_take_action(GAME_STRINGS.indexOf("ACTION_BANK_PAY_LOAN"));
                    if (!is_sentry(this.data.scene.error_code))
                    {
                        // ERROR_BANK_NOT_ENOUGH_DEPOSIT
                        // ERROR_BANK_NOT_ENOUGH_PLAYER_GOLD
                        // ERROR_BANK_NOT_ENOUGH_WITHDRAW
                        // ERROR_BANK_WITHDRAW_MORE_THAN_DEPOSIT
                        // ERROR_BANK_PAY_EXISTING_LOAN_FIRST
                        // ERROR_BANK_NOT_ENOUGH_LOAN
                        // ERROR_BANK_TOO_MUCH_LOAN
                        // ERROR_BANK_NO_LOAN
                        // ERROR_BANK_PAY_LOAN_NOT_ENOUGH
                        // ERROR_BANK_NOT_ENOUGH_PLAYER_GOLD
                        // ERROR_BANK_PAY_LOAN_MORE_THAN_LOAN
                    }
                    this.render();
                },
                withdraw: function ()
                {
                    var amount = document.getElementById("bank").querySelector("#bank_input_number").value;
                    this.data.bank.to_loan = amount;
                    wasm.exports.current_scene_take_action(GAME_STRINGS.indexOf("ACTION_BANK_WITHDRAW"));
                    if (!is_sentry(this.data.scene.error_code))
                    {
                        // ERROR_BANK_NOT_ENOUGH_DEPOSIT
                        // ERROR_BANK_NOT_ENOUGH_PLAYER_GOLD
                        // ERROR_BANK_NOT_ENOUGH_WITHDRAW
                        // ERROR_BANK_WITHDRAW_MORE_THAN_DEPOSIT
                        // ERROR_BANK_PAY_EXISTING_LOAN_FIRST
                        // ERROR_BANK_NOT_ENOUGH_LOAN
                        // ERROR_BANK_TOO_MUCH_LOAN
                        // ERROR_BANK_NO_LOAN
                        // ERROR_BANK_PAY_LOAN_NOT_ENOUGH
                        // ERROR_BANK_NOT_ENOUGH_PLAYER_GOLD
                        // ERROR_BANK_PAY_LOAN_MORE_THAN_LOAN
                    }
                    this.render();
                },
                render: function ()
                {
                    var html = ``;
                    var dialog_string = GAME_STRINGS[this.data.scene.dialog_id];
                    if (!STRINGS[dialog_string])
                    {
                        console.error(`Missing dialog string for bank [${dialog_string}]`);
                    }
                    var output_string = STRINGS[dialog_string];
                    if (dialog_string === "ACTION_BANK_DEPOSIT_SUCCESS")
                    {
                        output_string = output_string.replace("%d", this.data.bank.deposit_interest_rate);
                    }
                    var outer_border_style = `background: linear-gradient(306deg, #6186ee, #243fa8); padding: 2px; border-radius: 4px; max-width: fit-content;`;
                    var inner_text_style = `background:#0c2b6c; padding: 6px; max-width: 300px; max-height: 200px; overflow: auto; border: 1px solid black;`;
                    html += `
                    <div id="bank" style="max-width: fit-content; position: absolute; top: 0px;">
                        <div style="${outer_border_style}">
                            <div id="bank_dialog" style="${inner_text_style}">${output_string}</div>
                            <div id="bank_input">
                                <div>Gold: <input type="number" id="bank_input_number" min="1" max="10000" /></div>
                                <div>Your Gold: <span id="bank_your_gold">${wasm.exports.get_player_gold(0)}</span></div>
                            </div>
                            <div id="bank_info">
                                <div>Current Loan: <span id="bank_current_loan">${this.data.bank.loan_amount}</span></div>
                                <div>Current Deposit: <span id="bank_current_deposit">${this.data.bank.deposit_amount}</span></div>
                            </div>
                            <div id="bank_actions">
                                <button class="green" onclick="UI_BANK.takeLoan();">Take Loan</button>
                                <button class="green" onclick="UI_BANK.deposit();">Deposit</button>
                                <button class="green" onclick="UI_BANK.payLoan();">Pay Loan</button>
                                <button class="green" onclick="UI_BANK.withdraw();">Withdraw</button>
                                <button class="red" onclick="UI_BANK.exit();">Cancel</button>
                            </div>
                        </div>
                    </div>
                    `;
                    document.getElementById("bank").outerHTML = html;
                },
                exit: function ()
                {
                    document.getElementById("bank").outerHTML = `<div id="bank"></div>`;
                    wasm.exports.current_scene_take_action(GAME_STRINGS.indexOf("ACTION_EXIT"));
                    this.initialized = false;
                },
            }

            var UI_GENERAL_SHOP = 
            {
                data: {
                    shop: null,
                    inventory: null,
                },
                initialized: false,
                initialize: function ()
                {
                    if (!this.initialized)
                    {
                        this.data.shop = new GAME_DATA_SCENE_GENERAL_SHOP(wasm.exports);
                        this.data.inventory = new GAME_DATA_INVENTORY(wasm.exports, [this.data.shop.inventory_id]);
                        this.initialized = true;
                    }
                },
                render: function ()
                {
                    var html = ``;
                    var inner_text_style = `background:#0c2b6c; padding: 6px; max-width: 300px; max-height: 200px; overflow: auto; border: 1px solid black;`;
                    var inventory_list_style = `display: grid; grid-template-columns: 1fr 1fr 1fr; grid-gap: 5px; justify-items: center;`;
                    var outer_border_style = `background: linear-gradient(306deg, #6186ee, #243fa8); padding: 2px; border-radius: 4px; max-width: fit-content;`;
                    var list_html = ``;
                    for (var d = 0; d < this.data.inventory.total_items; ++d)
                    {
                        if (!is_sentry(this.data.inventory.inventory_items[d]))
                        {
                            var ghi = new GAME_DATA_INVENTORY_ITEM(wasm.exports, [this.data.inventory.inventory_items[d]]);
                            var name = STRINGS[GAME_STRINGS[ghi.name_id]];
                            list_html += `<div>${name}</div>`;
                            list_html += `<div><input class='shop_inventory_item' type='number' value='0' data-price='${ghi.adjusted_price}' data-id='${d}' style='width: 40px;' onclick='UI_GENERAL_SHOP.updateTotalPrice()' /></div>`;
                            list_html += `<div>${ghi.adjusted_price}</div>`;
                        }
                    }
                    html += `
                        <div id="inventory_menu" style="max-width: fit-content; position: absolute; top: 0px;">
                            <div style="${outer_border_style}">
                                <div style="${inner_text_style}">
                                    <div style="margin-bottom: 10px;">${STRINGS["SCENE_GENERAL_SHOP"]}</div>
                                    <div style="${inventory_list_style}">
                                        ${list_html}
                                        <div>TOTAL</div><div>&nbsp;</div><div><span id="inventory_total_price">0</span></div>
                                        <div><button class="green" onclick="UI_GENERAL_SHOP.buyItems()">Buy</button></div>
                                        <div>&nbsp;</div>
                                        <div><button class="red" onclick="UI_GENERAL_SHOP.cancel()">Cancel</button></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    document.getElementById("inventory_menu").outerHTML = html;
                },
                updateTotalPrice: function ()
                {
                    var total_price = 0;
                    var items = document
                        .getElementById("inventory_menu")
                        .querySelectorAll(".shop_inventory_item");
                    for (var i = 0; i < items.length; ++i)
                    {
                        if (items[i] instanceof HTMLElement && items[i].value > 0)
                        {
                            total_price += items[i].value * parseInt(items[i].dataset.price);
                            var id = parseInt(items[i].dataset.id);
                            this.data.shop.chosen_items[id] = items[i].value;
                        }
                    }
                    document.getElementById("inventory_total_price").innerHTML = total_price;
                },
                cancel: function ()
                {
                    document
                        .getElementById("inventory_menu")
                        .outerHTML = `<div id="inventory_menu"></div>`;
                    wasm.exports.current_scene_take_action(GAME_STRINGS.indexOf("ACTION_EXIT"));
                    this.initialized = false;
                },
                buyItems: function ()
                {
                    wasm.exports.current_scene_take_action(GAME_STRINGS.indexOf("ACTION_BUY"));
                    if (this.data.shop.flag_bought == true)
                    {
                        console.log("Successful purchase!");
                    }
                }
            };

            // gh = GameHelper
            var gh = {
                current: null,
                initialize: function ()
                {
                    this.current = new GAME_CURRENT(wasm.exports);
                    var max_worlds = wasm.exports.get_max_worlds();
                    for (var w = 0; w < max_worlds; ++w)
                    {
                        WORLDS[w] = new GAME_DATA_WORLD(wasm.exports, [w]);
                    }
                    // TODO: Inventories
                    // TODO: Captains
                    // First captain always equals first player
                    PLAYER.captain = new GAME_DATA_CAPTAIN(wasm.exports, [0]);
                },

                shouldRedrawEverything: function ()
                {
                    gh.current.updated_state = GAME_STRINGS.indexOf("UPDATED_STATE_EVERYTHING");
                },

                shouldUpdate: function (what)
                {
                    var everything = GAME_STRINGS.indexOf("UPDATED_STATE_EVERYTHING");
                    var scene = GAME_STRINGS.indexOf("UPDATED_STATE_SCENE");
                    var world = GAME_STRINGS.indexOf("UPDATED_STATE_WORLD");
                    if (gh.current.updated_state === everything)
                    {
                        return true;
                    }
                    if (what === "scene" && gh.current.updated_state === scene)
                    {
                        return true;
                    }
                    if (what === "world" && gh.current.updated_state === world)
                    {
                        return true;
                    }
                    return false;
                },

                getCurrentWorldName: function ()
                {
                    // TODO: Stop creating new views
                    var current = new GAME_CURRENT(wasm.exports);
                    // TODO: This is a weird way to get world name
                    return UNDERSTRINGS[GAME_STRINGS[current.world_name]];
                },

                // EDITOR
                editor:
                {
                    layer_strings: [],
                    active_layer_id: null,
                    active_layer_name_id: null,
                    current_wasm_value: null,
                    current_atlas_x: null,
                    current_atlas_y: null,
                    previous_wasm_value: null,
                    previous_atlas_x: null,
                    previous_atlas_y: null,
                    mode: null,
                },
                editorUpdateAtlasPreview: function ()
                {
                    var atlas_x = parseInt(document.getElementById("atlas_asset_x").value);
                    var atlas_y = parseInt(document.getElementById("atlas_asset_y").value);
                    document.getElementById("atlas_preview").style.setProperty("--atlas-x", atlas_x);
                    document.getElementById("atlas_preview").style.setProperty("--atlas-y", atlas_y);
                },
                editorSetModeToPull: function ()
                {
                    this.editor.mode = null;
                    document.getElementById("pull_layer_value").classList.remove("active");
                    document.getElementById("set_layer_value").classList.remove("active");
                    document.getElementById("pull_layer_value").classList.add("active");
                    this.editor.mode = "pull";
                },
                editorSetModeToSet: function ()
                {
                    this.editor.mode = null;
                    document.getElementById("pull_layer_value").classList.remove("active");
                    document.getElementById("set_layer_value").classList.remove("active");
                    document.getElementById("set_layer_value").classList.add("active");
                    this.editor.mode = "set";
                },
                editorSetLayerActiveID: function (name_id, id)
                {
                    this.editor.active_layer_id = id;
                    this.editor.active_layer_name_id = name_id;
                    var editor_layer_buttons = document.querySelectorAll(".editor_layer");
                    for (var e = 0; e < editor_layer_buttons.length; ++e)
                    {
                        if (editor_layer_buttons[e] instanceof HTMLElement)
                        {
                            editor_layer_buttons[e].classList.remove("active");
                        }
                    }
                    document.getElementById("editor_layer_" + id).classList.add("active");
                },
                editorGetLayers: function ()
                {
                    document.getElementById("layers_list").innerHTML = '';
                    var total_layers = WORLDS[gh.current.world].total_layers;
                    this.editor.layer_strings = [];
                    this.editor.active_layer_id = null;
                    this.editor.active_layer_name_id = null;
                    this.editor.current_wasm_value = null;
                    this.editor.current_atlas_x = null;
                    this.editor.current_atlas_y = null;
                    this.editor.previous_wasm_value = null;
                    this.editor.previous_atlas_x = null;
                    this.editor.previous_atlas_y = null;
                    this.editor.mode = null;
                    for (var t = 0; t < total_layers; ++t)
                    {
                        var layer_id = WORLDS[gh.current.world].layers[t];
                        var layer = new GAME_DATA_LAYER(wasm.exports, [layer_id]);
                        var name_id = GAME_STRINGS[layer.name_id];
                        var name = STRINGS[name_id];
                        this.editor.layer_strings.push({
                            layer_id,
                            name_id: layer.name_id,
                            name
                        });
                        document.getElementById("layers_list").innerHTML += "<button class='editor_layer' id='editor_layer_" + layer_id + "' onclick='gh.editorSetLayerActiveID(" + layer.name_id + ", " + layer_id + ")'>" + name + "</button>";
                    }
                    document.getElementById("pull_layer_value").classList.remove("active");
                    document.getElementById("set_layer_value").classList.remove("active");
                    console.log(this.editor.layer_strings);
                },
                editorSetLayerCoordinatesValue: function(layer_id, x, y, value)
                {
                    var original_value = wasm.exports.layer_get_value(layer_id, x, y);
                    // UNDO_COUNTER = 0 (actually equal to undo array.length - 1)
                    // [layer_id, x, y, original_value, updated_value]
                    // If you go backwards into the undo array and then make a NEW change, release everything in undo array from current UNDO_COUNTER to end of array
                    // REDO_COUNTER = UNDO_COUNTER + 1 -> reapply updated_value
                    // TODO: store original value in an array of changes so we can undo and redo
                    LAYER_COORDINATES_VALUE_HISTORY[LAYER_COORDINATES_VALUE_UNDO_COUNTER] = [
                        layer_id,
                        x, y,
                        original_value,
                        value
                    ];
                    ++LAYER_COORDINATES_VALUE_UNDO_COUNTER;
                    wasm.exports.layer_set_value(layer_id, x, y, value);
                },
                editorSetLayerCoordinatesValueUndo: function ()
                {
                    --LAYER_COORDINATES_VALUE_UNDO_COUNTER;
                    if (LAYER_COORDINATES_VALUE_UNDO_COUNTER < 0)
                    {
                        LAYER_COORDINATES_VALUE_UNDO_COUNTER = 0;
                    }
                    var data = LAYER_COORDINATES_VALUE_HISTORY[LAYER_COORDINATES_VALUE_UNDO_COUNTER];
                    wasm.exports.add_value_to_global_world_data(data[0], data[1], data[2], data[3]);
                    wasm.exports.should_redraw_everything();
                    // force_redraw = true;
                },
                editorSetLayerCoordinatesValueRedo: function ()
                {
                    if (LAYER_COORDINATES_VALUE_UNDO_COUNTER < LAYER_COORDINATES_VALUE_HISTORY.length)
                    {
                        var data = LAYER_COORDINATES_VALUE_HISTORY[LAYER_COORDINATES_VALUE_UNDO_COUNTER];
                        wasm.exports.add_value_to_global_world_data(data[0], data[1], data[2], data[4]);
                        wasm.exports.should_redraw_everything();
                        force_redraw = true;
                        --LAYER_COORDINATES_VALUE_UNDO_COUNTER;
                    }
                },
            }

            // uih = UIHelper
            var uih = {
                getViewport: function ()
                {
                    return document.getElementById("viewport");
                },
                updateLayers: function ()
                {
                    var total_layers = wasm.exports.get_storage_layer_total_used_slots();
                    var slots = game_get_storage_layer_used_slots(wasm.exports);
                    LAYERS = [];
                    for (var t = 0; t < total_layers; ++t)
                    {
                        var layer_id = slots[t];
                        LAYERS.push(new GAME_DATA_LAYER(wasm.exports, [layer_id]));
                    }
                },
                updatedRender: function ()
                {
                    var html = ``;
                    var total_layers = wasm.exports.get_storage_layer_total_used_slots();
                    var block_layer_id = null;
                    var layer_one_id = null;
                    var layer_two_id = null;
                    for (var t = 0; t < total_layers; ++t)
                    {
                        if (LAYERS[t].name_id === GAME_STRINGS.indexOf("LAYER_BACKGROUND"))
                        {
                            block_layer_id = t;
                        }
                        if (LAYERS[t].name_id === GAME_STRINGS.indexOf("LAYER_ONE"))
                        {
                            layer_one_id = t;
                        }
                        if (LAYERS[t].name_id === GAME_STRINGS.indexOf("LAYER_TWO"))
                        {
                            layer_two_id = t;
                        }
                    }
                    var total_world_npcs = wasm.exports.get_storage_world_npc_total_used_slots();
                    var npcs_slots = game_get_storage_npc_used_slots(wasm.exports);
                    var world_npcs = [];
                    for (var n = 0; n < total_world_npcs; ++n)
                    {
                        world_npcs.push(new GAME_DATA_WORLD_NPC(wasm.exports, [n]));
                    }

                    var cached_lam = LAYER_ATLAS_MAP[UNDERSTRINGS[GAME_STRINGS[gh.current.world_name]]];
                    var value, style;
                    for (var vy = 0; vy < VIEWPORT.height; ++vy)
                    {
                        for (var vx = 0; vx < VIEWPORT.width; ++vx)
                        {
                            var world_x = CAMERA.offset.x + vx;
                            var world_y = CAMERA.offset.y + vy;

                            style = `width: ${TILE_SIZE_SCALED}px; height: ${TILE_SIZE_SCALED}px; mix-blend-mode: normal;`;
                            // WHY WAS THIS SLOWER???
                            // style += `background-image: var(--atlas-image); background-position: calc(-1 * calc(var(--tile-scaled) * var(--atlas-x))) calc(-1 * calc(var(--tile-scaled) * var(--atlas-y))); background-size: var(--bg-size);`;
                            // style += `position: absolute; top: calc(${vy} * ${TILE_SIZE_SCALED}px); left: calc(${vx} * ${TILE_SIZE_SCALED}px);`;
                            if (should3d)
                            {
                                style += ` transform-style: preserve-3d; will-change: transform; backface-visibility: hidden;`;
                            }

                            html += `<div class="tile_element" data-world-x="${world_x}" data-world-y="${world_y}" data-viewport-x="${vx}" data-viewport-y="${vy}" style="${style}">`;
                            
                            value = get_layer_value(LAYERS[block_layer_id], world_x, world_y);
                            if (!is_sentry(value))
                            {
                                var atlas_x = cached_lam["background_layer"][value][0];
                                var atlas_y = cached_lam["background_layer"][value][1];
                                style = `--atlas-x: ${atlas_x}; --atlas-y: ${atlas_y}; position: absolute;`;
                                html += `<div class="atlas" data-layer-id="${block_layer_id}" data-layer="block" style="${style}"></div>`;
                            }

                            value = get_layer_value(LAYERS[layer_one_id], world_x, world_y);
                            if (!is_sentry(value))
                            {
                                var atlas_x = cached_lam["layer_one"][value][0];
                                var atlas_y = cached_lam["layer_one"][value][1];
                                style = `--atlas-x: ${atlas_x}; --atlas-y: ${atlas_y}; position: absolute;`;
                                html += `<div class="atlas" data-layer-id="${layer_one_id}" data-layer="layer_one" style="${style}"></div>`;
                            }

                            value = get_layer_value(LAYERS[layer_two_id], world_x, world_y);
                            if (!is_sentry(value))
                            {
                                var atlas_x = cached_lam["layer_two"][value][0];
                                var atlas_y = cached_lam["layer_two"][value][1];
                                style = `--atlas-x: ${atlas_x}; --atlas-y: ${atlas_y}; position: absolute;`;
                                html += `<div class="atlas" data-layer-id="${layer_two_id}" data-layer="layer_two" style="${style}"></div>`;
                            }

                            // NPCS
                            for (var n = 0; n < world_npcs.length; ++n)
                            {
                                if (world_npcs[n].position_x === world_x && world_npcs[n].position_y === world_y)
                                {
                                    var atlas_x = cached_lam["npc_layer"][n][0];
                                    var atlas_y = cached_lam["npc_layer"][n][1];
                                    style = `--atlas-x: ${atlas_x}; --atlas-y: ${atlas_y}; position: absolute;`;
                                    if (should3d)
                                    {
                                        style += ` transform: rotateX(90deg) rotateZ(180deg) rotateY(180deg) translate3d(0px, -16px, 0px);`;
                                        style += ` transform-style: preserve-3d;`;
                                        style += ` will-change: transform;`;
                                        style += ` backface-visibility: hidden;`;
                                    }
                                    html += `<div class="atlas layer-npc_layer" data-npc-id="${n}" style="${style}"></div>`;
                                }
                            }

                            // entities?
                            // blocks?

                            html += `</div>`;
                        }
                    }
                    return html;
                },
                updateRootProperties()
                {
                    // :root update
                    var de = document.documentElement;
                    de.style.setProperty("--atlas-width", TILE_SIZE_SCALED + "px");
                    de.style.setProperty("--atlas-height", TILE_SIZE_SCALED + "px");
                    de.style.setProperty("--tile-scaled", TILE_SIZE_SCALED + "px");
                },
                initialize: function ()
                {
                    this.getViewport().style.display = "grid";
                    this.getViewport().style.gridTemplateRows = `repeat(${VIEWPORT.height}, 1fr)`;
                    this.getViewport().style.gridTemplateColumns = `repeat(${VIEWPORT.width}, 1fr)`;
                    dragElement(document.getElementById("meta-game"), document.getElementById("meta-game-drag-handle"));

                    wasm.exports.tick();
                    uih.updateLayers();
                    uih.getViewport().innerHTML = uih.updatedRender();
                },

                // NOTE: Keeping this here so we can use it later
                renderCannonAttack: function(attacker_tile_element, target_tile_element)
                {
                    if (attacker_tile_element && target_tile_element)
                    {
                        var cannon_tile = document.createElement('div');
                        cannon_tile.id = "cannon_tile";
                        cannon_tile.style.position = "absolute";
                        cannon_tile.style.zIndex = "100";
                        cannon_tile.style.width = TILE_SIZE_SCALED + "px";
                        cannon_tile.style.height = TILE_SIZE_SCALED + "px";
                        cannon_tile.classList.add("atlas");
                        cannon_tile.style.backgroundPosition = "calc(-1 * calc(64px * 9)) calc(-1 * calc(64px * 1))";
                        cannon_tile.style.top = attacker_tile_element.getClientRects()[0].top + "px";
                        cannon_tile.style.left = attacker_tile_element.getClientRects()[0].left + "px";
                        var attacker_animation_y = attacker_tile_element.getClientRects()[0].top;
                        var attacker_animation_x = attacker_tile_element.getClientRects()[0].left;
                        var target_animation_y = target_tile_element.getClientRects()[0].top;
                        var target_animation_x = target_tile_element.getClientRects()[0].left;
                        // target_tile_element.style.border = "3px solid white";
                        document.body.appendChild(cannon_tile);
                        var animation_interval = setInterval(() => {
                            if (target_animation_x > attacker_animation_x)
                            {
                                attacker_animation_x += 5;
                                if (attacker_animation_x > target_animation_x) {
                                    attacker_animation_x = target_animation_x;
                                }
                            }
                            else
                            {
                                attacker_animation_x -= 5;
                                if (attacker_animation_x < target_animation_x)
                                {
                                    attacker_animation_x = target_animation_x;
                                }
                            }
                            cannon_tile.style.left = attacker_animation_x + "px";
                            if (target_animation_y > attacker_animation_y)
                            {
                                attacker_animation_y += 5;
                                if (attacker_animation_y > target_animation_y)
                                {
                                    attacker_animation_y = target_animation_y;
                                }
                            }
                            else
                            {
                                attacker_animation_y -= 5;
                                if (attacker_animation_y < target_animation_y)
                                {
                                    attacker_animation_y = target_animation_y;
                                }
                            }
                            cannon_tile.style.top = attacker_animation_y + "px";
                            if (
                                attacker_animation_x == target_animation_x &&
                                attacker_animation_y == target_animation_y
                            ) {
                                cannon_tile.remove();
                                clearInterval(animation_interval);
                            }
                        }, 20);
                    }
                    else
                    {
                        console.log("Target", target_tile_element);
                        console.log("Attacker", attacker_tile_element);
                    }
                },
            };

            var force_redraw = false;
            // var rotateX = 67
            var RAF = {
                fps: 60,
                interval: 1000,
                last_time: 0,
                is_paused: false,
                last_log_time: 0,
                log_interval: 0,
                fps_value: 0,
                last_fps_time: 0,
                frame_count: 0,
                initialize: function ()
                {
                    RAF.interval = RAF.interval / RAF.fps;
                },
                animate: function(current_time)
                {
                    requestAnimationFrame(RAF.animate);

                    if (!RAF.is_paused)
                    {
                        // Calculate time elapsed since last frame
                        var delta_time = current_time - RAF.last_time;

                        // Only update if enough time has passed
                        if (delta_time >= RAF.interval)
                        {
                            // Update last time, accounting for any extra time
                            RAF.last_time = current_time - (delta_time % RAF.interval);

                            RAF.update(delta_time, current_time);
                            RAF.render();

                            ++RAF.frame_count;
                        }
                    }

                    // Calculate FPS every second
                    if (current_time - RAF.last_fps_time >= 1000)
                    {
                        RAF.fps_value = Math.round((RAF.frame_count * 1000) / (current_time - RAF.last_fps_time));
                        RAF.frame_count = 0;
                        RAF.last_fps_time = current_time;
                    }
                },
                update: function(delta_time, current_time)
                {
                    if (current_time - RAF.last_log_time >= RAF.log_interval)
                    {
                        RAF.last_log_time = current_time;
                    }
                    // TODO: Update should_render_tiles here instead
                    // wasm.tick
                    // should_render_tiles = true;
                },
                can_tick: true,
                render: function ()
                {
                    if (wasm)
                    {
                        if (RAF.frame_count % 15 == 0)
                        {
                            // var bg_elements = document.querySelectorAll('.layer-background_layer');
                            // for (var bge = 0; bge < bg_elements.length; ++bge)
                            // {
                            //     if (bg_elements[bge] instanceof HTMLElement)
                            //     {
                            //         if (bg_elements[bge].bgTick == undefined || bg_elements[bge].bgTick == NaN)
                            //         {
                            //             bg_elements[bge].bgTick = 0;
                            //         }
                            //         var bgTick = bg_elements[bge].bgTick;
                            //         ++bg_elements[bge].bgTick;
                            //         if (bg_elements[bge].bgTick > 7)
                            //         {
                            //             bg_elements[bge].bgTick = 0;
                            //         }
                            //         bg_elements[bge].style.backgroundPosition = 'calc(-1 * calc(32px * ' + bgTick + ')) 0px';
                            //     }
                            // }
                        }
                        if (gh.current.game_mode === GAME_STRINGS.indexOf("GAME_MODE_IN_PLAYER_MENU"))
                        {
                            gh.current.updated_state = GAME_STRINGS.indexOf("UPDATED_STATE_NOTHING");
                            UI_PLAYER_MENU.initialize();
                            UI_PLAYER_MENU.render();
                        }
                        else if (gh.current.game_mode === GAME_STRINGS.indexOf("GAME_MODE_IN_SCENE"))
                        {
                            scene_name = GAME_STRINGS[gh.current.scene];
                            if (!gh.shouldUpdate("scene")) { return; }
                            if (
                                scene_name === "SCENE_NPC_RVICE"
                                ||
                                scene_name === "SCENE_NPC_LAFOLIE"
                                ||
                                scene_name === "SCENE_NPC_NAKOR"
                                ||
                                scene_name === "SCENE_NPC_TRAVIS"
                                ||
                                scene_name === "SCENE_NPC_LOLLER"
                            )
                            {
                                gh.current.updated_state = GAME_STRINGS.indexOf("UPDATED_STATE_NOTHING");
                                UI_SCENE_SINGLE_DIALOG.initialize();
                                UI_SCENE_SINGLE_DIALOG.render();
                            }
                            else if (scene_name === "SCENE_GENERAL_SHOP")
                            {
                                gh.current.updated_state = GAME_STRINGS.indexOf("UPDATED_STATE_NOTHING");
                                UI_GENERAL_SHOP.initialize();
                                UI_GENERAL_SHOP.render();
                            }
                            else if (scene_name === "SCENE_BANK")
                            {
                                gh.current.updated_state = GAME_STRINGS.indexOf("UPDATED_STATE_NOTHING");
                                UI_BANK.initialize();
                                UI_BANK.render();
                            }
                        }
                        else
                        {
                            if (PLAYER.previous_world_npc_id !== PLAYER.captain.world_npc_id)
                            {
                                PLAYER.world_npc = new GAME_DATA_WORLD_NPC(wasm.exports, [PLAYER.captain.world_npc_id]);
                                PLAYER.previous_world_npc_id = PLAYER.captain.world_npc_id;
                            }
                            if (!is_sentry(PLAYER.world_npc.position_x))
                            {
                                if (
                                    (PLAYER.world_npc.position_x - CAMERA.offset.x) > (VIEWPORT.width / 2)
                                    &&
                                    (CAMERA.offset.x + VIEWPORT.width) < WORLDS[gh.current.world].width
                                )
                                {
                                    CAMERA.moveRight();
                                }
                                else if (
                                    (PLAYER.world_npc.position_x - CAMERA.offset.x) < (VIEWPORT.width / 2)
                                    &&
                                    CAMERA.offset.x > 0
                                )
                                {
                                    CAMERA.moveLeft();
                                }
                                if (
                                    (PLAYER.world_npc.position_y - CAMERA.offset.y) > (VIEWPORT.height / 2)
                                    &&
                                    (CAMERA.offset.y + VIEWPORT.height) < WORLDS[gh.current.world].height
                                )
                                {
                                    CAMERA.moveDown();
                                }
                                else if (
                                    (PLAYER.world_npc.position_y - CAMERA.offset.y) < (VIEWPORT.height / 2)
                                    &&
                                    CAMERA.offset.y > 0
                                )
                                {
                                    CAMERA.moveUp();
                                }
                            }
                            uih.getViewport().innerHTML = uih.updatedRender();
                        }
                        wasm.exports.tick();
                    } else {
                        alert("NO WASM");
                    }
                },
                togglePause: function ()
                {
                    RAF.is_paused = !RAF.is_paused
                    console.log(RAF.is_paused ? 'RAF paused' : 'RAF resumed')
                }
            }

            window.addEventListener('load', function ()
            {
                RAF.initialize();
                var multiplayer = URLPARAMS.get('is_multiplayer');
                if (multiplayer === 1 || multiplayer === true || multiplayer === "true" || multiplayer === "1")
                {
                    // TOOD: This
                }

                var base64 = true;
                if (base64)
                {
                    var bytes = Uint8Array.from(atob(wasmBase64), c => c.charCodeAt(0));
                    WebAssembly.instantiate(bytes, importObject).then(results => {
                        var instance = results.instance;
                        wasm = instance;

                        // NOTE: This is how you call a function that's not exported. JS calls WASM functions through the indirect function table.
                        // console.log(wasm);
                        // console.log(wasm.exports.__indirect_function_table);
                        // console.log(wasm.exports.__indirect_function_table.get(1)());

                        console.log("Starting memory:", formatMemorySize(wasm.exports.memory.buffer.byteLength));
                        console.log("Pages:", wasm.exports.memory.buffer.byteLength / 65536);

                        start_game();
                    });
                }
                else
                {
                    fetch('wasm_game.wasm')
                        .then(function(response) { return response.arrayBuffer() })
                        .then(function(bytes) { return WebAssembly.instantiate(bytes, importObject) })
                        .then(function(results) {
                            var instance = results.instance;
                            wasm = instance;

                            console.log("Starting memory:", formatMemorySize(wasm.exports.memory.buffer.byteLength));
                            console.log("Pages:", wasm.exports.memory.buffer.byteLength / 65536);

                            start_game();
                        });
                }

                // NOTE: Keeping this here because, in the future, we may want this
                // async function loadGameTextFromUrl(url) {
                //     const response = await fetch(url);
                //     const binaryData = await response.arrayBuffer();
                //     const uint8Array = new Uint8Array(binaryData);
                    
                //     return loadGameText(uint8Array);                }

                // // Usage example:
                // loadGameTextFromUrl('text_data.bin')
                //     .then(gameText => {
                //         console.log(gameText); // Your array of text strings
                //     })
                //     .catch(error => {
                //         console.error("Error loading game text:", error);
                //     });
            });

            var should3d = false;
            function toggleShouldThreeD()
            {
                document.body.classList.toggle("should_3d");
                should3d = !should3d;
            }

            var game_mode;
            var TILE_SIZE = 16;
            var TILE_SCALE = 2;
            var TILE_SIZE_SCALED = TILE_SIZE * TILE_SCALE;
            function start_game()
            {
                console.log('Starting game here');

                VIEWPORT.width = 20;
                VIEWPORT.height = 20;
                uih.getViewport().style.width = (TILE_SIZE_SCALED * VIEWPORT.width) + 'px';
                uih.getViewport().style.height = (TILE_SIZE_SCALED * VIEWPORT.height) + 'px';
                uih.updateRootProperties();
                wasm.exports.initialize_game();
                console.log("Current memory:", formatMemorySize(wasm.exports.memory.buffer.byteLength));
                gh.initialize();
                if (gh.current.game_mode == GAME_STRINGS.indexOf("GAME_MODE_EMPTY"))
                {
                    uih.initialize();
                    console.log("GAME IS EMPTY. STARTING RAF");
                    requestAnimationFrame(RAF.animate);
                }

                var degx = 85;
                var degy = 0;
                var ctrl_down = false;
                document.addEventListener('mousemove', function (e)
                {
                    if (should3d && ctrl_down)
                    {
                        degx += e.movementX;
                        degy += e.movementY;
                        // Note: Yes, it's backwards
                        document
                            .getElementById("viewport")
                            .style
                            .setProperty("--rotate-x", degy + "deg");
                        document
                            .getElementById("viewport")
                            .style
                            .setProperty("--rotate-y", degx + "deg");
                    }
                });

                document.getElementById("viewport").addEventListener("mousemove", function (e)
                {
                    var offsetX = Math.floor(e.clientX / TILE_SIZE_SCALED);
                    var offsetY = Math.floor(e.clientY / TILE_SIZE_SCALED);
                    var world_x = offsetX + CAMERA.offset.x;
                    var world_y = offsetY + CAMERA.offset.y;
                    document.getElementById("debug_viewport_x").innerHTML = "Viewport X: " + offsetX;
                    document.getElementById("debug_viewport_y").innerHTML = "Viewport Y: " + offsetY;
                    document.getElementById("debug_world_x").innerHTML = "World X: " + world_x;
                    document.getElementById("debug_world_y").innerHTML = "World Y: " + world_y;
                    document.getElementById("debug_layer_value").innerHTML = "";
                    for (var i = 0; i < LAYERS.length; ++i)
                    {
                        var name_id = GAME_STRINGS[LAYERS[i].name_id];
                        var name = STRINGS[name_id];
                        var value = get_layer_value(LAYERS[i], world_x, world_y);
                        document.getElementById("debug_layer_value").innerHTML += `<div>Layer ${name}: ${value}</div>`;
                    }
                });

                document.getElementById("viewport").addEventListener("mousedown", function (e)
                {
                    var offsetX = Math.floor(e.clientX / TILE_SIZE_SCALED);
                    var offsetY = Math.floor(e.clientY / TILE_SIZE_SCALED);
                    var world_x = offsetX + CAMERA.offset.x;
                    var world_y = offsetY + CAMERA.offset.y;

                    if (gh.editor.mode === "pull")
                    {
                        // we need to pull atlas_asset_x && atlas_asset_y
                        for (var i = 0; i < LAYERS.length; ++i)
                        {
                            if (LAYERS[i].name_id === gh.editor.active_layer_name_id)
                            {
                                var value = get_layer_value(LAYERS[i], world_x, world_y);
                                document.getElementById("wasm_value").value = value;
                                var name_id = GAME_STRINGS[LAYERS[i].name_id];
                                var layer_name = "layer_" + UNDERSTRINGS[name_id];
                                if (
                                    LAYER_ATLAS_MAP[gh.getCurrentWorldName()]
                                    &&
                                    LAYER_ATLAS_MAP[gh.getCurrentWorldName()][layer_name]
                                    &&
                                    LAYER_ATLAS_MAP[gh.getCurrentWorldName()][layer_name][value]
                                )
                                {
                                    document.getElementById("atlas_asset_x").value = LAYER_ATLAS_MAP[gh.getCurrentWorldName()][layer_name][value][0];
                                    document.getElementById("atlas_asset_y").value = LAYER_ATLAS_MAP[gh.getCurrentWorldName()][layer_name][value][1];
                                    gh.editorUpdateAtlasPreview();
                                }
                                break;
                            }
                        }
                    }
                    if (gh.editor.mode === "set")
                    {
                        var wasm_value = parseInt(document.getElementById("wasm_value").value);
                        var atlas_x = parseInt(document.getElementById("atlas_asset_x").value);
                        var atlas_y = parseInt(document.getElementById("atlas_asset_y").value);
                        var layer_id = gh.editor.active_layer_id;
                        gh.editorSetLayerCoordinatesValue(layer_id, world_x, world_y, wasm_value);
                        if (!LAYER_ATLAS_MAP[gh.getCurrentWorldName()])
                        {
                            LAYER_ATLAS_MAP[gh.getCurrentWorldName()] = [];
                        }
                        if (!LAYER_ATLAS_MAP[gh.getCurrentWorldName()][layer_name])
                        {
                            LAYER_ATLAS_MAP[gh.getCurrentWorldName()][layer_name] = [];
                        }
                        if (!LAYER_ATLAS_MAP[gh.getCurrentWorldName()][layer_name][wasm_value])
                        {
                            LAYER_ATLAS_MAP[gh.getCurrentWorldName()][layer_name][wasm_value] = [];
                        }
                        LAYER_ATLAS_MAP[gh.getCurrentWorldName()][layer_name][wasm_value][0] = atlas_x;
                        LAYER_ATLAS_MAP[gh.getCurrentWorldName()][layer_name][wasm_value][1] = atlas_y;
                    }
                });

                document.addEventListener('keydown', function (e)
                {
                    switch (e.code)
                    {
                        case "ControlLeft":
                            ctrl_down = true;
                            break;
                    }
                });

                document.addEventListener('keyup', function (e)
                {
                    if (IS_MULTIPLAYER && e.target.matches("#multiplayer-chat-message-input"))
                    {
                        ctrl_down = false;
                        return;
                    }
                    var should_redraw = true;
                    switch (e.code)
                    {
                        case "ControlLeft":
                            ctrl_down = false;
                            should_redraw = false;
                            break;
                        case "KeyZ":
                            wasm.exports.user_input_a();
                            break;
                        case "KeyX":
                            wasm.exports.user_input_b();
                            break;
                        case "KeyC":
                            wasm.exports.user_input_x();
                            break;
                        case "KeyV":
                            wasm.exports.user_input_y();
                            break;
                        case "KeyA":
                            wasm.exports.user_input_left();
                            break;
                        case "KeyD":
                            wasm.exports.user_input_right();
                            break;
                        case "KeyW":
                            wasm.exports.user_input_up();
                            break;
                        case "KeyS":
                            wasm.exports.user_input_down();
                            break;
                        case "KeyQ":
                            wasm.exports.user_input_left_bumper();
                            break;
                        case "KeyE":
                            wasm.exports.user_input_right_bumper();
                            break;
                        case "KeyT":
                            wasm.exports.user_input_start();
                            break;
                        case "KeyG":
                            wasm.exports.user_input_select();
                            break;
                        case "KeyI":
                            // TODO: These won't work because we update the viewport every frame
                            // Do a forced camera move and then add a reset button of some kind
                            CAMERA.moveUp();
                            break;
                        case "KeyK":
                            CAMERA.moveDown();
                            break;
                        case "KeyJ":
                            CAMERA.moveLeft();
                            break;
                        case "KeyL":
                            CAMERA.moveRight();
                            break;
                        default:
                            should_redraw = false;
                            break;
                    }
                    if (should_redraw)
                    {
                        gh.shouldRedrawEverything();
                    }
                })
            }

            var debug_blocks = false;
            function toggleBlocks()
            {
                debug_blocks = !debug_blocks;
            }
            var debug_entities = false;
            function toggleEntities()
            {
                debug_entities = !debug_entities;
            }
        </script>
    </head>
    <body>
        <div id="viewport" style="display: none;"></div>

        <div class="popup" id="meta-game">
            <div class="grid">
                <div id="meta-game-drag-handle" class="drag-bar svg svg-handle-bar-white"></div>
                <div id="meta-content">
                    <button id="help" onclick="uih.toggleHelp();">Help</button>
                    <button id="debug" onclick="wasm.exports.test();">DEBUG</button>
                    <button id="should3d" onclick="toggleShouldThreeD();">3D</button>
                    <button id="toggle_blocks" onclick="toggleBlocks();">Toggle Blocks</button>
                    <button id="toggle_entities" onclick="toggleEntities();">Toggle Entities</button>
                    <button id="raf_toggle_pause" onclick="RAF.togglePause();">Pause Unpause Anims</button>
                    <button id="debug_placeholder" onclick="">Placeholder</button>
                    <button id="load_athens" onclick="wasm.exports.generate_world(GAME_STRINGS.indexOf('WORLD_ATHENS'))">Load Athens</button>
                    <div>
                        <div id="debug_viewport_x">Viewport X: 0</div>
                        <div id="debug_viewport_y">Viewport Y: 0</div>
                    </div>
                    <div>
                        <div id="debug_world_x">World X: 0</div>
                        <div id="debug_world_y">World Y: 0</div>
                        <div id="debug_layer_value">Layer Value: 0</div>
                    </div>
                    <button id="pull_layer_value" onclick="gh.editorSetModeToPull();">Pull Value</button>
                    <button id="set_layer_value" onclick="gh.editorSetModeToSet();">Set Value</button>
                    <div id="layers">
                        <div>Layers</div>
                        <button id="get_layers" onclick="gh.editorGetLayers();">Get Layers</button>
                        <div id="layers_list" style="display: grid; grid-auto-flow: row;"></div>
                    </div>
                    <div id="atlas_assets">
                        <div>Atlas</div>
                        <div style="display: grid; grid-auto-flow: column; align-items: center; margin-bottom: 10px;">
                            <div>V:</div>
                            <input type="number" id="wasm_value" style="width: 80px;" />
                        </div>
                        <div id="atlas_asset" style="display: grid; grid-gap: 10px;">
                            <div style="display: grid; grid-auto-flow: column; align-items: center;">
                                <div>X:</div>
                                <div><input type="number" value="0" id="atlas_asset_x" style="width: 80px;" onchange="gh.editorUpdateAtlasPreview()" /></div>
                            </div>
                            <div style="display: grid; grid-auto-flow: column; align-items: center;">
                                <div>Y:</div>
                                <div><input type="number" value="1" id="atlas_asset_y" style="width: 80px;" onchange="gh.editorUpdateAtlasPreview()" /></div>
                            </div>
                            <div id="atlas_preview" class="atlas"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <dialog id="help_dialog" class="popup">
            <header>Help</header>
            <p>TODO: Mouse (not currently working)</p>
            <p>Keyboard</p>
            <table>
                <tr>
                    <td>Key</td>
                    <td>Action</td>
                </tr>
                <tr>
                    <td>W</td>
                    <td>Up</td>
                </tr>
                <tr>
                    <td>S</td>
                    <td>Down</td>
                </tr>
                <tr>
                    <td>A</td>
                    <td>Left</td>
                </tr>
                <tr>
                    <td>D</td>
                    <td>Right</td>
                </tr>
                <tr>
                    <td>Z</td>
                    <td>A/Confirm</td>
                </tr>
                <tr>
                    <td>X</td>
                    <td>B/Back</td>
                </tr>
                <tr>
                    <td>I</td>
                    <td>Move Camera Up</td>
                </tr>
                <tr>
                    <td>K</td>
                    <td>Move Camera Down</td>
                </tr>
                <tr>
                    <td>J</td>
                    <td>Move Camera Left</td>
                </tr>
                <tr>
                    <td>L</td>
                    <td>Move Camera Right</td>
                </tr>
            </table>
            <p>If you toggle 3D mode on, just hold down the Left CTRL key and drag the mouse around the screen. The entire world will rotate in 3D.</p>
            <form method="dialog">
                <button>ok</button>
            </form>
        </dialog>
        <div id="inventory_menu"></div>
        <div id="player_menu"></div>
        <div id="scene_single_dialog"></div>
        <div id="bank"></div>
        <div id="blackjack"></div>
        <div id="shipyard"></div>
    </body>
</html>
